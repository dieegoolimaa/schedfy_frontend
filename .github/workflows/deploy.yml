name: Deploy Frontend to GCP Cloud Run

on:
    push:
        branches:
            - main
            - production
    pull_request:
        branches:
            - main
    workflow_dispatch:

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    SERVICE_NAME: schedfy-frontend
    REGION: us-central1

jobs:
    lint-and-test:
        name: Lint and Test
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint --if-present || echo "No lint script found"

            - name: Run type check
              run: npm run type-check --if-present || echo "No type-check script found"

            - name: Run tests
              run: npm run test --if-present || echo "No test script found"

    build-and-deploy:
        name: Build and Deploy to Cloud Run
        runs-on: ubuntu-latest
        needs: lint-and-test
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Configure Docker for GCR
              run: |
                  gcloud auth configure-docker

            - name: Set environment variables
              run: |
                  if [ "${{ github.ref }}" == "refs/heads/production" ]; then
                    echo "ENVIRONMENT=production" >> $GITHUB_ENV
                    echo "API_URL=${{ secrets.PRODUCTION_API_URL }}" >> $GITHUB_ENV
                  else
                    echo "ENVIRONMENT=staging" >> $GITHUB_ENV
                    echo "API_URL=${{ secrets.STAGING_API_URL }}" >> $GITHUB_ENV
                  fi

            - name: Build Docker image
              run: |
                  docker build \
                    --build-arg VITE_API_URL=${{ env.API_URL }} \
                    --build-arg VITE_APP_ENV=${{ env.ENVIRONMENT }} \
                    -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
                    -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
                    .

            - name: Push Docker image to GCR
              run: |
                  docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
                  docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.SERVICE_NAME }} \
                    --image=gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
                    --platform=managed \
                    --region=${{ env.REGION }} \
                    --allow-unauthenticated \
                    --port=80 \
                    --memory=512Mi \
                    --cpu=1 \
                    --min-instances=0 \
                    --max-instances=10 \
                    --set-env-vars="VITE_API_URL=${{ env.API_URL }},VITE_APP_ENV=${{ env.ENVIRONMENT }}"

            - name: Get Service URL
              id: deploy
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                    --region=${{ env.REGION }} \
                    --format='value(status.url)')
                  echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
                  echo "### ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Service URL:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
                  echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

            - name: Create deployment summary
              run: |
                  echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Service | ${{ env.SERVICE_NAME }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Region | ${{ env.REGION }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Image | gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| URL | ${{ steps.deploy.outputs.service_url }} |" >> $GITHUB_STEP_SUMMARY

    notify:
        name: Notify Deployment Status
        runs-on: ubuntu-latest
        needs: build-and-deploy
        if: always()

        steps:
            - name: Notify Success
              if: needs.build-and-deploy.result == 'success'
              run: |
                  echo "✅ Deployment succeeded!"
                  # Add Slack/Discord notification here if needed

            - name: Notify Failure
              if: needs.build-and-deploy.result == 'failure'
              run: |
                  echo "❌ Deployment failed!"
                  # Add Slack/Discord notification here if needed
